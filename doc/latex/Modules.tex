This page list the description of some special BG\+\_\+\+Flood modules

\mbox{\hyperlink{HaloGradient}{Halo and gradient}}

\mbox{\hyperlink{ILCL}{Ground infiltration\+: Initial Loss -\/ Continuous Loss}}

\mbox{\hyperlink{WetdryfixConservelevation}{Conserve Elevation}} \hypertarget{HaloGradient}{}\doxysection{Halo and gradient}\label{HaloGradient}
Using multi-\/resolution in BG\+\_\+\+Flood, we need to keep track of how blocks with different resolutions talk to each other. This page tries to explain how this is done.\hypertarget{HaloGradient_autotoc_md73}{}\doxysubsubsection{Why halo}\label{HaloGradient_autotoc_md73}
In BUQ grid we keep track of a ring of cells (halo) on every edge of the block. These cells store the information corresponding to the neighbor cells on the neighbor block. If the neighbor block is at the same level of refinement, the values in the halo are a simple copy otherwise they are calculated using the operations described below. The point of the halo is that, when doing operations on a block, the model doesn\textquotesingle{}t need to look at other blocks. It also makes it cleaner and avoid repeating the costly calculation needed when two blocks are at a different levels of refinment.

The halo cells exist for all variables including gradients so, even when looking at immediate neighbor cells we can make 2nd order calculations.

Here is a diagram for a block of 16x16 cells\+:


\begin{DoxyInlineImage}
\includegraphics[height=\baselineskip,keepaspectratio=true]{block_description.png}%blockimg
\end{DoxyInlineImage}
\hypertarget{HaloGradient_autotoc_md74}{}\doxysubsubsection{Restriction and prolongation}\label{HaloGradient_autotoc_md74}
In Basilisk the operation to calculate a value from one level to another are called restriction and prolongation depending whether you calculate from coarse to fine or fine to coarse.

If the two blocks are the same level of refinement\+:


\begin{DoxyInlineImage}
\includegraphics[height=\baselineskip,keepaspectratio=true]{block_SCopy.png}%block\+SCopy
\end{DoxyInlineImage}


otherwise\+:


\begin{DoxyInlineImage}
\includegraphics[height=\baselineskip,keepaspectratio=true]{block_restriction.png}%block\+Prolog
\end{DoxyInlineImage}
\hypertarget{HaloGradient_autotoc_md75}{}\doxyparagraph{Prolongation}\label{HaloGradient_autotoc_md75}
Prolongation is the action of extending a value from a coarse cell to a finer cell. Often this is done by using the gradient value. e.\+g.\+:

\$\$\+HaloB = A + Gradient(\+A) $\ast$ dx $\ast$ 0.\+5\$\$\hypertarget{HaloGradient_autotoc_md76}{}\doxyparagraph{Restriction}\label{HaloGradient_autotoc_md76}
Restriction is where we calculate the value of a coarse cell from values of fine cells. This is usually done with cell average. \$\$\+HaloA = 0.\+25$\ast$(B1+\+B2+\+B3+\+B4)\$\$\hypertarget{HaloGradient_autotoc_md77}{}\doxysubsubsection{Filling the Halo\+: The chicken and the egg.}\label{HaloGradient_autotoc_md77}
When doing a prolongation operation one needs the gradient of the variable but to calculate gradient the halo needs to be filled. This is a chicken and egg situation.

The naive way of doing this is to first do restiction, calculate a gradient (everywhere), then doing the prolongation and then recalculating the gradient (everywhere) to fix the gradient in the cell neighboring prologation cells. This is inefficient!

Instead we first fill the halo for straight copy cells and restriction cells. Then calculate gradient (everywhere) and then do the prolongation where needed and then recalculating the gradient on cells near halo only.\hypertarget{HaloGradient_autotoc_md78}{}\doxysubsubsection{Conserving elevation}\label{HaloGradient_autotoc_md78}
Using prolongation at the wet/dry interface can lead to inconsistencies between h and zs. To limit the inconsistency zs is calculated from h after a prolongation calculation (see refine\+\_\+linear). While this conserves mass, it, however, leads to a violation of the lake-\/at-\/rest resulting in (small) spurious velocity at that interface. To remove the instability and preserve the elevation of the water (rather than its mass) we use a conserve elevation option (conserveelevation = true). This gets rid of the instability and preserves the elevation of the water level but then violates the mass conservation.\hypertarget{HaloGradient_autotoc_md79}{}\doxysubsubsection{Fluxes halo are a bit different}\label{HaloGradient_autotoc_md79}
\hypertarget{ILCL}{}\doxysection{Ground infiltration\+: Initial Loss -\/ Continuous Loss}\label{ILCL}
Rainfall is often absorbed in soil and leaf litter before joining surface flow.\+The default behaviour of BG\+\_\+\+Flood is to assume the rainfall given as input is actually \href{https://en.wikipedia.org/wiki/Surface_runoff}{\texttt{ runoff}} (i.\+e. rainfall exess that will make the surface flows). Instead a basic initial -\/ continuous loss model can be apply to approximate runoff.\hypertarget{ILCL_autotoc_md80}{}\doxysubsubsection{Model implemented}\label{ILCL_autotoc_md80}
The Initial Loss -\/ Continuous Loss (ILCL) is a very basic model for infiltration of surface water in the soil. It requires the input of two maps, based on the soil properties\+: one containing an initial loss coefficient $il$ in mm, the second containing a continuous loss coefficient $cl$ in mm/hr.

In this model, the initial and continuous losses are applied directly on the water elevation computed on each cell (and not by modifying the rain input). The value of the initial loss $il$ is estimated to be the total of water infiltrating in the ground before the beginning of the surface runoff, whereas the continuous loss $cl$ is the loss that occurs, on wet cells, from the begining of the surface runoff to the end of the simulation. The water absorbed in the ground will be tracked using the ground water elevation variable $hgw$ but wont be reintroduced to the surface flow through the computation process.

On each cell, at each simulation step, we can express the quantity of water absorbed in the ground $ha_{t}$ using\+:



where $il$ and $cl$ are respectively the initial loss and continuous loss coefficient at a given cell location, and $hgw_{t}$ is the accumulated ground water at this cell location since the begining of the simulation.

The water absorbed is then added to the ground water tracking variable\+: \$\$hgw\+\_\+\{t\}=hgw\+\_\+\{t-\/1\} + ha\+\_\+\{t\}\$\$ and removed from the surface water height and the surface water elevation (not shown here)\+: \$\$h\+\_\+\{t \textbackslash{};final\} = h\+\_\+\{t\} -\/ ha\+\_\+\{t\}\$\$

The following figure shows a representation of the initial loss -\/ continuing loss model with $il = 10 mm$ and $cl = 1 mm/s$ \+:


\begin{DoxyInlineImage}
\includegraphics[height=\baselineskip,keepaspectratio=true]{RainLosses.png}%Initial loss and continuing loss reprensentation during a cell-\/wetting event
\end{DoxyInlineImage}


{\itshape Initial loss and continuing loss reprensentation during a cell-\/wetting event}\hypertarget{ILCL_autotoc_md81}{}\doxyparagraph{$<$strong$>$\+Important notes$<$/strong$>$\+:}\label{ILCL_autotoc_md81}
-\/$>$ All cells that are initially wet at the begining of the simulation ( $h > XParam.eps$) will have their initial loss ( $il$) set to 0.\+0, in order to be consistent with the physic of the model.


\begin{DoxyCode}{0}
\DoxyCodeLine{-\/> This model is meant to be used with the rain on grid feature. The model is applied indistinctively to water from any source and can cause unexpected results if misused.}

\end{DoxyCode}
 \hypertarget{ILCL_autotoc_md82}{}\doxysubsubsection{Testcase for the ILCL model}\label{ILCL_autotoc_md82}
The ILCL model is tested in the Westport (ANZ) area, on the Orowaiti river (with a uniform 5m grid). A 20mm/hr rain is uniformly applied on the domain during 30 minutes. An initial loss of 5mm and an continuous loss of 5mm/h are used to define infiltration uniformly on the domain. The results, compared to a reference case without infiltration, are presented in the following figure. 
\begin{DoxyInlineImage}
\includegraphics[height=\baselineskip,keepaspectratio=true]{Ex_Merge.png}%Model\+\_\+test
\end{DoxyInlineImage}
\hypertarget{ILCL_autotoc_md83}{}\doxysubsubsection{Reference values}\label{ILCL_autotoc_md83}
Some reference values for the $il$ and $cl$ coefficients can be found in the literature. Some relate to entire subcatchment and are estimated from hydrology, other can be defined using local information (type of soil, rain antecedents, soil layer depth, ...). Whatever you select, be mindfull the model is likely to be very sensitive to rainfall loss.

The Initial loss is usually defined based on the antecedent moisture conditions and the soil layer depth and range from 0 to 50mm. The \href{http://book.arr.org.au.s3-website-ap-southeast-2.amazonaws.com/}{\texttt{ Australian Rainfall \& Runoff project}} concidere the initial loss value at a catchemnt scale and observed a low mean value of 1.\+1mm in urban catchments; in rural catchment, the initial loss is highly variable with a mean of 32mm and a standard deviation of 17mm.

The Constant loss rate can typically be related to the saturated hydraulic conductivity. The following table as been produced by \href{http://soilphysics.okstate.edu/teaching/soil-6583/references-folder/rawls\%20et\%20al\%201983.pdf}{\texttt{ Rawls, Brakensiek, and Miller (1983)}} using mesurements on soil samples from the USA.

\tabulinesep=1mm
\begin{longtabu}spread 0pt [c]{*{2}{|X[-1]}|}
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Soil texture class   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Hydraulic conductivity or continuous loss (mm/h)    }\\\cline{1-2}
\endfirsthead
\hline
\endfoot
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Soil texture class   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Hydraulic conductivity or continuous loss (mm/h)    }\\\cline{1-2}
\endhead
Sand   &117.\+8    \\\cline{1-2}
Loamy sand   &29.\+9    \\\cline{1-2}
Sandy loam   &10.\+9    \\\cline{1-2}
Loam   &3.\+4    \\\cline{1-2}
Silt loam   &6.\+5    \\\cline{1-2}
Sandy clay loam   &1.\+5    \\\cline{1-2}
Clay loam   &1.\+0    \\\cline{1-2}
Silty clay loam   &1.\+0    \\\cline{1-2}
Sandy clay   &0.\+6    \\\cline{1-2}
Silty clay   &0.\+5    \\\cline{1-2}
Clay   &0.\+3   \\\cline{1-2}
\end{longtabu}


Below is the ARR 2016 Rainfall Loss Parameters for Urban area, depending of the surface type\+: \tabulinesep=1mm
\begin{longtabu}spread 0pt [c]{*{3}{|X[-1]}|}
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Urban Surface   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Burst Initial loss (mm)   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Continuing loss (mm/hr)    }\\\cline{1-3}
\endfirsthead
\hline
\endfoot
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Urban Surface   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Burst Initial loss (mm)   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Continuing loss (mm/hr)    }\\\cline{1-3}
\endhead
\PBS\centering Effective Impervious Area   &0.\+4   &0.\+0    \\\cline{1-3}
\PBS\centering Indirectly Connected Area   &16.\+1   &1.\+6    \\\cline{1-3}
\PBS\centering Urban Pervious Area   &26.\+9   &1.\+6   \\\cline{1-3}
\end{longtabu}


Below is an other example of compilation of some of these values from \href{https://help.innovyze.com/display/xprafts/Initial+and+Continuing+Loss+Model}{\texttt{ https\+://help.\+innovyze.\+com/display/xprafts/\+Initial+and+\+Continuing+\+Loss+\+Model}}.


\begin{DoxyInlineImage}
\includegraphics[height=\baselineskip,keepaspectratio=true]{ILCL-values.png}%ILCL-\/table
\end{DoxyInlineImage}
 \hypertarget{WetdryfixConservelevation}{}\doxysection{Conserve Elevation}\label{WetdryfixConservelevation}
At the interface of coarse and fine blocks we often cannot {\bfseries{strictly}} conserve both mass (h) and water elevation. The difference in most cases is relatively small but near the wet/dry interface, trying to conserve mass leads to instabilities. Since these instabilities are a bit annoying by default BG\+\_\+\+Flood enforces the conservation of elevation at the interface between coarse and fine blocks where wet and dry cells are present. This might lead to a mismatch between the expected volume and actual volume when simulating rain or river flooding. Similarly, ignoring the conserve elevation requirement when simulating a tsunami can lead to a underestimate of the tsunami. The impact of these switch is small and we can show how small they are below.

Below are two examples of basic flood model to test the impact of the wet/dry instability fix (hereafter wetdryfix) on mass conservation. Further below is to test the impact of the wetdryfix and conserve elevation routimne (hereafter conserve\+Elevation) on a tsunami wave propagating on a real steep bathymetry (Samoa).\hypertarget{WetdryfixConservelevation_autotoc_md84}{}\doxysubsubsection{Mass conservation implication}\label{WetdryfixConservelevation_autotoc_md84}
Using the Waikanae topo with cst rain at 50mm/h for 1 hour. using the rainbnd option and wall bnd on all side. Results are undestinguishable from each other and after 1 hr the model has {\bfseries{100.\+48\%}} of the theoretical volume of water in both with and without the wetdryfix. ~\newline


For comparison the current {\bfseries{Dev}} branch has 100.\+19\% of the theoretical volume. While this is somehow better it does not really undermine the new branch (i.\+e. the dev branch might get closer to the theory for the wrong raisons), the bugfixes and instability improvement of this branch are totally justified.

results \tabulinesep=1mm
\begin{longtabu}spread 0pt [c]{*{3}{|X[-1]}|}
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ \% of theoretical volume   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ runtime    }\\\cline{1-3}
\endfirsthead
\hline
\endfoot
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ \% of theoretical volume   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ runtime    }\\\cline{1-3}
\endhead
Wetdry fix   &100.\+48\%   &97s    \\\cline{1-3}
{\bfseries{NO}} Wetdryfix   &100.\+48\%   &96s   \\\cline{1-3}
\end{longtabu}
\hypertarget{WetdryfixConservelevation_autotoc_md85}{}\doxysubsubsection{Tsumani test results}\label{WetdryfixConservelevation_autotoc_md85}
The impact of the wet/dry fix should be much more obvious in tsunami simulation but here conserve elevation should be used in most tsunami cases.\hypertarget{WetdryfixConservelevation_autotoc_md86}{}\doxyparagraph{No wetdryfix}\label{WetdryfixConservelevation_autotoc_md86}
switching off the wetdryfix causes instability that really have an impact on tsunami wave. Here the instability are clearly visible in the map and in the comparison are seen as 0.\+01 m waves before the tsunami wave arrive.

\hypertarget{WetdryfixConservelevation_autotoc_md87}{}\doxyparagraph{Wetdryfix}\label{WetdryfixConservelevation_autotoc_md87}
When using the wetdryfix the instabilities disappear and the solution is smoother.

\hypertarget{WetdryfixConservelevation_autotoc_md88}{}\doxyparagraph{Comparison Wetdryfix vs no Wetdryfix}\label{WetdryfixConservelevation_autotoc_md88}
The instabilities are more obvious when we look at a transect diagonally from the plot above. These instabilities have a notable affect the height of the tsunami wave... a lot! This justifies that we should have the wetdryfix switched on by default.

\hypertarget{WetdryfixConservelevation_autotoc_md89}{}\doxyparagraph{Conserve Elevation}\label{WetdryfixConservelevation_autotoc_md89}
When running tsunami/storm surge simulation without rivers or rain then the conserve elevation should be switched on. This doesn\textquotesingle{}t make a considerable impact on the tsunami wave (see transect above the red and blue line are indistinguishable) I\textquotesingle{}m not sure why the difference is so small but there is a difference. Below is the difference between the wetdryfix and conservelevation routine. it produces a difference of O(10-\/5).

 